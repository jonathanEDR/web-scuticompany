import type { PageData, PageSeo, ButtonStyle } from '../../types/cms';
import type { ThemeConfig } from '../../contexts/ThemeContext';

export const useCmsUpdaters = (
  pageData: PageData | null, 
  setPageData: (data: PageData) => void,
  setThemeConfig?: (config: ThemeConfig) => void
) => {
  
  const updateContent = (field: string, value: any) => {
    if (!pageData) return;

    const keys = field.split('.');
    const newData = { ...pageData };
    let current: any = newData.content;

    for (let i = 0; i < keys.length - 1; i++) {
      // Si no existe el objeto, crearlo
      if (!current[keys[i]]) {
        current[keys[i]] = {};
      }
      // Si es un string (formato anterior) y necesitamos convertir a objeto
      if (typeof current[keys[i]] === 'string' && keys[i] === 'backgroundImage') {
        current[keys[i]] = { dark: current[keys[i]] }; // Mover string existente a dark
      }
      current = current[keys[i]];
    }

    current[keys[keys.length - 1]] = value;
    setPageData(newData);
  };

  const updateTextStyle = (section: 'hero' | 'solutions', field: string, mode: 'light' | 'dark', color: string) => {
    if (!pageData) return;

    setPageData({
      ...pageData,
      content: {
        ...pageData.content,
        [section]: {
          ...pageData.content[section],
          styles: {
            ...pageData.content[section].styles,
            [mode]: {
              ...pageData.content[section].styles?.[mode],
              [field]: color
            }
          }
        }
      }
    });
  };

  const updateSeo = (field: keyof PageSeo, value: any) => {
    if (!pageData) return;
    
    setPageData({
      ...pageData,
      seo: {
        ...pageData.seo,
        [field]: value
      }
    });
  };

  const updateTheme = (mode: 'lightMode' | 'darkMode', field: string, value: string) => {
    if (!pageData || !pageData.theme) return;
    
    console.log(`ðŸŽ¨ Actualizando tema ${mode}.${field}:`, value);
    
    const newTheme = {
      ...pageData.theme,
      [mode]: {
        ...pageData.theme[mode],
        [field]: value
      }
    };
    
    const newPageData = {
      ...pageData,
      theme: newTheme
    };
    
    setPageData(newPageData);
    
    // IMPORTANTE: Actualizar ThemeContext
    if (setThemeConfig) {
      console.log('âœ… Sincronizando tema con contexto');
      setThemeConfig(newTheme as ThemeConfig);
    }
  };

  const updateThemeDefault = (value: 'light' | 'dark') => {
    if (!pageData || !pageData.theme) return;
    
    console.log(`ðŸŽ¨ Cambiando tema por defecto a:`, value);
    
    const newTheme = {
      ...pageData.theme,
      default: value
    };
    
    const newPageData = {
      ...pageData,
      theme: newTheme
    };
    
    setPageData(newPageData);
    
    // IMPORTANTE: Actualizar ThemeContext
    if (setThemeConfig) {
      console.log('âœ… Sincronizando tema por defecto con contexto');
      setThemeConfig(newTheme as ThemeConfig);
    }
  };

  const updateSimpleButtonStyle = (mode: 'lightMode' | 'darkMode', buttonType: 'ctaPrimary' | 'contact' | 'dashboard', style: ButtonStyle) => {
    if (!pageData || !pageData.theme) return;

    console.log(`ðŸŽ¨ Actualizando botÃ³n ${buttonType} en modo ${mode}:`, style);

    // Asegurar que la estructura existe
    const currentTheme = { ...pageData.theme };
    if (!currentTheme[mode].buttons) {
      currentTheme[mode].buttons = {
        ctaPrimary: { background: 'transparent', textColor: '#8B5CF6', borderColor: 'transparent' },
        contact: { background: 'transparent', textColor: '#8B5CF6', borderColor: '#8B5CF6' },
        dashboard: { background: '#8B5CF6', textColor: '#FFFFFF', borderColor: 'transparent' }
      };
    }

    const newTheme = {
      ...currentTheme,
      [mode]: {
        ...currentTheme[mode],
        buttons: {
          ...currentTheme[mode].buttons,
          [buttonType]: style
        }
      }
    };

    const newPageData = {
      ...pageData,
      theme: newTheme
    };
    
    // Actualizar pageData
    setPageData(newPageData);
    
    // IMPORTANTE: TambiÃ©n actualizar el ThemeContext inmediatamente
    if (setThemeConfig) {
      console.log('âœ… Aplicando configuraciÃ³n de tema actualizada al contexto');
      setThemeConfig(newTheme as ThemeConfig);
    }
  };

  return {
    updateContent,
    updateTextStyle,
    updateSeo,
    updateTheme,
    updateThemeDefault,
    updateSimpleButtonStyle
  };
};